/*!
* Copyright Â© 2021 Ken Haggerty (https://kenhaggerty.com)
* Licensed under the MIT License.
* SignalR Online User Count - Version 1.0.1
* Depends on signalr.js
*/var centrifuge;var isConnected;function CentrifugoConnect(){InitCentrifugo();var isOnIOS=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i);var eventName=isOnIOS?"pagehide":"beforeunload";window.addEventListener(eventName,function(e)
{centrifuge.disconnect();});window.addEventListener("visibilitychange",function(e)
{if(document.visibilityState==='visible')
{if(centrifuge!=null)
InitCentrifugo();}else
{centrifuge.disconnect();}});}
function ConfigureCentrifugo()
{updateSubscription=centrifuge.subscribe("updateMap",function(ctx){UpdateMap(ctx.data);});onlineSubscription=centrifuge.subscribe("onlineCount",function(ctx){UpdateUsersCount(ctx.data);});}
var isParsedDataFromError=false;function InitCentrifugo()
{const apiToken=$('input#api-token').val();const centrifugoUrl=$('input#centrifugo-url').val();centrifuge=new Centrifuge(centrifugoUrl,{url:centrifugoUrl,refreshEndpoint:"/api/centrifuge/refreshToken",refreshHeaders:{"Authorization":"Bearer "+apiToken},retry:100,resubscribe:true,refreshAttempts:1,onRefreshFailed:function(){window.location.reload();},onTransportClose:function(ctx){console.log(ctx.event);if(((ctx.event.type=="close"&&ctx.event.wasClean==false)||ctx.event.code==1006)&&isParsedDataFromError==false){ParseData();isParsedDataFromError=true;}}});centrifuge.setToken($('input#centrifugo-token').val());centrifuge.on('connect',function(ctx){isConnected=true;GetHistory();});centrifuge.on('disconnect',function(ctx){isConnected=false;});centrifuge.on('error',function(ctx){console.log('error',ctx);window.location.reload();});ConfigureCentrifugo();centrifuge.connect();}
function GetHistory()
{centrifuge.history("updateMap",{since:{offset:0,epoch:"xyz"},limit:1}).then(function(resp){if(resp.publications!=null&&resp.publications.length>0)
UpdateMap(resp.publications[0].data);else
ParseData();},function(err){ParseData();console.log('history error',err);});centrifuge.history("onlineCount",{since:{offset:0,epoch:"xyz"},limit:1}).then(function(resp){if(resp.publications!=null&&resp.publications.length>0)
UpdateUsersCount(resp.publications[0].data);},function(err){console.log('history error',err);});}
function UpdateMap(data)
{SetData(data.alerts,data.artillery,data.actionIndex.lastActionIndex);}
function UpdateUsersCount(data)
{var onlineCount=document.querySelector('.online-users-count');if(onlineCount)onlineCount.innerText=data.count;}